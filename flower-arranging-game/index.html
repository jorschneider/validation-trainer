<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atelier - Arrange the Masters</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;1,400&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Cormorant Garamond', Georgia, serif;
            background: #1a1612;
            min-height: 100vh;
            color: #e8e0d5;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: linear-gradient(180deg, #252018 0%, #1a1612 100%);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            padding: 24px 20px;
            overflow-y: auto;
        }

        .logo {
            font-size: 22px;
            font-weight: 400;
            letter-spacing: 4px;
            color: #f0e6d8;
            margin-bottom: 6px;
        }

        .tagline {
            font-size: 12px;
            font-style: italic;
            color: #8a7a68;
            margin-bottom: 28px;
        }

        .artist-section {
            margin-bottom: 20px;
        }

        .artist-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .artist-thumb {
            width: 36px;
            height: 36px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .artist-info h3 {
            font-size: 13px;
            font-weight: 400;
            font-style: italic;
            color: #c0b0a0;
        }

        .artist-info p {
            font-size: 10px;
            color: #6a5a48;
        }

        .flowers-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .flower-btn {
            width: 58px;
            height: 58px;
            border: 2px solid transparent;
            border-radius: 8px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.25s ease;
            padding: 4px;
            overflow: hidden;
        }

        .flower-btn canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .flower-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .flower-btn.active {
            background: rgba(180,140,80,0.15);
            border-color: #b48c50;
            box-shadow: 0 0 15px rgba(180,140,80,0.25);
        }

        .controls {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .control-row {
            margin-bottom: 16px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6a5a48;
            margin-bottom: 8px;
        }

        .slider {
            width: 100%;
            height: 3px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #b48c50;
            border-radius: 50%;
            cursor: pointer;
        }

        .btn-row {
            display: flex;
            gap: 8px;
        }

        .btn {
            flex: 1;
            padding: 10px 12px;
            border: 1px solid rgba(255,255,255,0.15);
            background: transparent;
            color: #a09080;
            font-family: inherit;
            font-size: 12px;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.08);
            color: #e0d8c8;
        }

        .btn.primary {
            background: rgba(180,140,80,0.2);
            border-color: #b48c50;
            color: #b48c50;
        }

        .canvas-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 30px;
            background: radial-gradient(ellipse at center, #2a2420 0%, #1a1612 100%);
        }

        .canvas-frame {
            background: linear-gradient(145deg, #3a3028, #2a2420);
            padding: 12px;
            border-radius: 4px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        .canvas-inner {
            background: #28221c;
            padding: 4px;
        }

        #canvas {
            display: block;
            cursor: crosshair;
        }

        .help {
            position: fixed;
            bottom: 14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-style: italic;
            color: #5a4a38;
        }

        .loading {
            position: fixed;
            inset: 0;
            background: #1a1612;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 20px;
            z-index: 1000;
        }

        .loading.hidden { display: none; }

        .loading-text { font-size: 14px; letter-spacing: 3px; color: #8a7a68; }

        .loader {
            width: 30px; height: 30px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: #b48c50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loader"></div>
        <div class="loading-text">CUTTING FLOWERS FROM MASTERPIECES</div>
    </div>

    <div class="app">
        <div class="sidebar">
            <div class="logo">ATELIER</div>
            <div class="tagline">Flowers cut from the masters</div>
            <div id="artistSections"></div>

            <div class="controls">
                <div class="control-row">
                    <div class="control-label">
                        <span>Size</span>
                        <span id="sizeVal">120</span>
                    </div>
                    <input type="range" class="slider" id="sizeSlider" min="60" max="250" value="120">
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="undo()">Undo</button>
                    <button class="btn" id="flipBtn" onclick="toggleFlip()">Flip</button>
                    <button class="btn" onclick="clearAll()">Clear</button>
                </div>
                <div class="btn-row" style="margin-top: 8px">
                    <button class="btn primary" onclick="save()">Save Image</button>
                </div>
            </div>
        </div>

        <div class="canvas-container">
            <div class="canvas-frame">
                <div class="canvas-inner">
                    <canvas id="canvas"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="help">Click to place · Scroll to rotate · Right-click to remove · Toggle Flip for mirror</div>

<script>
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');

// Paintings with hand-traced flower cutout paths
// Paths are normalized coordinates [0-1] relative to image dimensions
// Using flower-shaped paths with petal-like extensions for natural cutouts
const PAINTINGS = [
    {
        artist: 'Vincent van Gogh',
        title: 'Sunflowers, 1888',
        url: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/Vincent_van_Gogh_-_Sunflowers_-_VGM_F458.jpg',
        flowers: [
            {
                name: 'Golden Crown',
                // Large sunflower at top center - flower-shaped path with petals
                path: [
                    [0.50, 0.05], [0.45, 0.06], [0.42, 0.04], [0.38, 0.07],
                    [0.35, 0.05], [0.32, 0.09], [0.30, 0.08], [0.28, 0.12],
                    [0.26, 0.15], [0.28, 0.18], [0.26, 0.21], [0.29, 0.24],
                    [0.32, 0.26], [0.36, 0.25], [0.40, 0.27], [0.44, 0.26],
                    [0.48, 0.28], [0.52, 0.28], [0.56, 0.26], [0.60, 0.27],
                    [0.64, 0.25], [0.68, 0.26], [0.71, 0.24], [0.74, 0.21],
                    [0.72, 0.18], [0.74, 0.15], [0.72, 0.12], [0.70, 0.08],
                    [0.68, 0.09], [0.65, 0.05], [0.62, 0.07], [0.58, 0.04],
                    [0.55, 0.06], [0.50, 0.05]
                ]
            },
            {
                name: 'Leaning Left',
                // Sunflower leaning to the left side
                path: [
                    [0.22, 0.14], [0.18, 0.12], [0.14, 0.14], [0.11, 0.18],
                    [0.10, 0.22], [0.12, 0.26], [0.10, 0.30], [0.14, 0.34],
                    [0.18, 0.36], [0.24, 0.35], [0.29, 0.32], [0.32, 0.28],
                    [0.33, 0.23], [0.31, 0.19], [0.28, 0.15], [0.22, 0.14]
                ]
            },
            {
                name: 'Right Bloom',
                // Sunflower on the right
                path: [
                    [0.78, 0.12], [0.74, 0.10], [0.70, 0.12], [0.67, 0.16],
                    [0.66, 0.21], [0.68, 0.26], [0.72, 0.30], [0.77, 0.31],
                    [0.82, 0.29], [0.86, 0.25], [0.88, 0.20], [0.87, 0.15],
                    [0.84, 0.11], [0.78, 0.12]
                ]
            },
            {
                name: 'Center Face',
                // Central flower face
                path: [
                    [0.50, 0.30], [0.44, 0.32], [0.39, 0.36], [0.37, 0.42],
                    [0.39, 0.48], [0.44, 0.52], [0.50, 0.53], [0.56, 0.52],
                    [0.61, 0.48], [0.63, 0.42], [0.61, 0.36], [0.56, 0.32],
                    [0.50, 0.30]
                ]
            },
            {
                name: 'Withered Bloom',
                // Lower withered/drooping sunflower
                path: [
                    [0.32, 0.42], [0.26, 0.46], [0.22, 0.52], [0.24, 0.58],
                    [0.28, 0.62], [0.35, 0.63], [0.42, 0.60], [0.46, 0.54],
                    [0.44, 0.48], [0.38, 0.44], [0.32, 0.42]
                ]
            }
        ]
    },
    {
        artist: 'Claude Monet',
        title: 'Water Lilies, 1906',
        url: 'https://upload.wikimedia.org/wikipedia/commons/a/aa/Claude_Monet_-_Water_Lilies_-_1906%2C_Ryerson.jpg',
        flowers: [
            {
                name: 'Red Lily',
                // Red flower cluster near upper-left as described in research
                path: [
                    [0.18, 0.22], [0.13, 0.24], [0.10, 0.28], [0.09, 0.33],
                    [0.11, 0.38], [0.16, 0.41], [0.22, 0.42], [0.27, 0.39],
                    [0.30, 0.34], [0.29, 0.28], [0.25, 0.24], [0.18, 0.22]
                ]
            },
            {
                name: 'Right Cluster',
                // Main lily cluster in right region
                path: [
                    [0.72, 0.35], [0.65, 0.38], [0.60, 0.44], [0.58, 0.52],
                    [0.62, 0.60], [0.70, 0.64], [0.80, 0.62], [0.88, 0.56],
                    [0.92, 0.48], [0.90, 0.40], [0.84, 0.36], [0.72, 0.35]
                ]
            },
            {
                name: 'Bottom Lilies',
                // Bottom region lily cluster
                path: [
                    [0.25, 0.72], [0.18, 0.76], [0.14, 0.82], [0.16, 0.88],
                    [0.24, 0.92], [0.36, 0.94], [0.48, 0.92], [0.56, 0.86],
                    [0.54, 0.78], [0.46, 0.74], [0.36, 0.72], [0.25, 0.72]
                ]
            },
            {
                name: 'Pink Bloom',
                // Single pink water lily flower
                path: [
                    [0.42, 0.48], [0.36, 0.50], [0.32, 0.55], [0.34, 0.61],
                    [0.40, 0.65], [0.48, 0.66], [0.54, 0.62], [0.56, 0.56],
                    [0.52, 0.50], [0.46, 0.48], [0.42, 0.48]
                ]
            }
        ]
    },
    {
        artist: 'Gustav Klimt',
        title: 'Cottage Garden, 1907',
        url: 'https://upload.wikimedia.org/wikipedia/commons/e/ed/Klimt_bauerngarten.jpg',
        flowers: [
            {
                name: 'Giant Sunflower',
                // Klimt's sunflower at top - very decorative
                path: [
                    [0.50, 0.02], [0.42, 0.04], [0.36, 0.03], [0.30, 0.06],
                    [0.26, 0.10], [0.24, 0.16], [0.26, 0.22], [0.30, 0.26],
                    [0.36, 0.28], [0.42, 0.29], [0.50, 0.30], [0.58, 0.29],
                    [0.64, 0.28], [0.70, 0.26], [0.74, 0.22], [0.76, 0.16],
                    [0.74, 0.10], [0.70, 0.06], [0.64, 0.03], [0.58, 0.04],
                    [0.50, 0.02]
                ]
            },
            {
                name: 'Red Poppies',
                // Cluster of red poppies
                path: [
                    [0.20, 0.50], [0.12, 0.54], [0.08, 0.62], [0.10, 0.70],
                    [0.18, 0.76], [0.28, 0.78], [0.38, 0.74], [0.44, 0.66],
                    [0.42, 0.58], [0.34, 0.52], [0.20, 0.50]
                ]
            },
            {
                name: 'White Daisies',
                // White flowers in middle area
                path: [
                    [0.48, 0.42], [0.40, 0.46], [0.36, 0.54], [0.38, 0.62],
                    [0.46, 0.68], [0.56, 0.70], [0.66, 0.66], [0.70, 0.58],
                    [0.68, 0.50], [0.60, 0.44], [0.48, 0.42]
                ]
            },
            {
                name: 'Purple Patch',
                // Purple/blue flower cluster
                path: [
                    [0.72, 0.48], [0.64, 0.52], [0.60, 0.60], [0.62, 0.70],
                    [0.70, 0.78], [0.82, 0.80], [0.92, 0.74], [0.96, 0.64],
                    [0.92, 0.54], [0.82, 0.50], [0.72, 0.48]
                ]
            }
        ]
    },
    {
        artist: 'Vincent van Gogh',
        title: 'Irises, 1889',
        url: 'https://upload.wikimedia.org/wikipedia/commons/3/3e/Irises-Vincent_van_Gogh.jpg',
        flowers: [
            {
                name: 'Blue Iris Left',
                // Tall iris on the left side
                path: [
                    [0.15, 0.18], [0.10, 0.22], [0.08, 0.28], [0.10, 0.36],
                    [0.14, 0.44], [0.12, 0.52], [0.16, 0.58], [0.22, 0.56],
                    [0.26, 0.48], [0.24, 0.40], [0.28, 0.32], [0.26, 0.24],
                    [0.22, 0.18], [0.15, 0.18]
                ]
            },
            {
                name: 'Center Iris',
                // Central iris bloom
                path: [
                    [0.42, 0.24], [0.35, 0.28], [0.32, 0.36], [0.35, 0.44],
                    [0.40, 0.50], [0.48, 0.52], [0.55, 0.48], [0.58, 0.40],
                    [0.56, 0.32], [0.50, 0.26], [0.42, 0.24]
                ]
            },
            {
                name: 'Right Iris',
                // Iris on the right
                path: [
                    [0.68, 0.20], [0.62, 0.24], [0.58, 0.32], [0.60, 0.42],
                    [0.66, 0.50], [0.74, 0.52], [0.82, 0.48], [0.86, 0.38],
                    [0.84, 0.28], [0.78, 0.22], [0.68, 0.20]
                ]
            },
            {
                name: 'White Iris',
                // The single white iris that stands out
                path: [
                    [0.24, 0.62], [0.18, 0.66], [0.16, 0.74], [0.20, 0.82],
                    [0.28, 0.86], [0.38, 0.84], [0.44, 0.78], [0.42, 0.70],
                    [0.36, 0.64], [0.24, 0.62]
                ]
            }
        ]
    }
];

let paintingImages = {};
let flowerCutouts = [];
let selectedFlower = 0;
let size = 120;
let rotation = 0;
let flipped = false;
let placed = [];
let history = [];

// Cut out a flower using a traced path with smooth curves
function cutOutFlower(img, path, padding = 0.03) {
    // Find bounding box
    let minX = 1, maxX = 0, minY = 1, maxY = 0;
    path.forEach(([x, y]) => {
        minX = Math.min(minX, x);
        maxX = Math.max(maxX, x);
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
    });

    // Add padding
    minX = Math.max(0, minX - padding);
    maxX = Math.min(1, maxX + padding);
    minY = Math.max(0, minY - padding);
    maxY = Math.min(1, maxY + padding);

    const srcX = minX * img.width;
    const srcY = minY * img.height;
    const srcW = (maxX - minX) * img.width;
    const srcH = (maxY - minY) * img.height;

    // Create cutout canvas
    const cutoutSize = 320;
    const scale = cutoutSize / Math.max(srcW, srcH);
    const w = srcW * scale;
    const h = srcH * scale;

    const offCanvas = document.createElement('canvas');
    offCanvas.width = cutoutSize;
    offCanvas.height = cutoutSize;
    const offCtx = offCanvas.getContext('2d');

    // Center the cutout
    const offsetX = (cutoutSize - w) / 2;
    const offsetY = (cutoutSize - h) / 2;

    // Convert path points to canvas coordinates
    const points = path.map(([px, py]) => ({
        x: ((px - minX) / (maxX - minX)) * w + offsetX,
        y: ((py - minY) / (maxY - minY)) * h + offsetY
    }));

    // Draw smooth curved path using cardinal spline
    offCtx.beginPath();

    // Use quadratic curves through control points for smooth organic shape
    if (points.length > 2) {
        offCtx.moveTo(points[0].x, points[0].y);

        for (let i = 0; i < points.length; i++) {
            const p0 = points[(i - 1 + points.length) % points.length];
            const p1 = points[i];
            const p2 = points[(i + 1) % points.length];
            const p3 = points[(i + 2) % points.length];

            // Catmull-Rom to Bezier conversion for smooth curves
            const tension = 0.5;
            const cp1x = p1.x + (p2.x - p0.x) * tension / 3;
            const cp1y = p1.y + (p2.y - p0.y) * tension / 3;
            const cp2x = p2.x - (p3.x - p1.x) * tension / 3;
            const cp2y = p2.y - (p3.y - p1.y) * tension / 3;

            offCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
        }
    }
    offCtx.closePath();

    // Create soft feathered edge mask
    offCtx.save();

    // First pass: draw the image clipped to path
    offCtx.clip();
    offCtx.drawImage(img, srcX, srcY, srcW, srcH, offsetX, offsetY, w, h);
    offCtx.restore();

    // Add subtle edge softening by drawing semi-transparent edge
    offCtx.save();
    offCtx.globalCompositeOperation = 'destination-out';

    // Create feathered edge by drawing shrinking strokes
    for (let blur = 6; blur > 0; blur--) {
        offCtx.lineWidth = blur;
        offCtx.strokeStyle = `rgba(0,0,0,${0.15 * (blur / 6)})`;

        offCtx.beginPath();
        if (points.length > 2) {
            offCtx.moveTo(points[0].x, points[0].y);
            for (let i = 0; i < points.length; i++) {
                const p0 = points[(i - 1 + points.length) % points.length];
                const p1 = points[i];
                const p2 = points[(i + 1) % points.length];
                const p3 = points[(i + 2) % points.length];
                const tension = 0.5;
                const cp1x = p1.x + (p2.x - p0.x) * tension / 3;
                const cp1y = p1.y + (p2.y - p0.y) * tension / 3;
                const cp2x = p2.x - (p3.x - p1.x) * tension / 3;
                const cp2y = p2.y - (p3.y - p1.y) * tension / 3;
                offCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
        }
        offCtx.closePath();
        offCtx.stroke();
    }
    offCtx.restore();

    return offCanvas;
}

async function loadPaintings() {
    const loadingEl = document.getElementById('loading');
    let loaded = 0;

    for (const painting of PAINTINGS) {
        await new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                paintingImages[painting.title] = img;

                // Cut out each flower
                painting.flowers.forEach(flower => {
                    flowerCutouts.push({
                        canvas: cutOutFlower(img, flower.path),
                        name: flower.name,
                        artist: painting.artist,
                        title: painting.title,
                        thumbUrl: painting.url
                    });
                });

                loaded++;
                resolve();
            };
            img.onerror = () => {
                console.error('Failed:', painting.title);
                loaded++;
                resolve();
            };
            img.src = painting.url;
        });
    }

    loadingEl.classList.add('hidden');
    init();
}

function drawVase(ctx, w, h) {
    const vaseW = w * 0.26;
    const vaseH = h * 0.36;
    const vaseX = w / 2;
    const vaseY = h - 8;

    // Shadow
    ctx.beginPath();
    ctx.ellipse(vaseX, vaseY + 5, vaseW * 0.45, 12, 0, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(0,0,0,0.15)';
    ctx.fill();

    // Vase
    ctx.beginPath();
    ctx.moveTo(vaseX - vaseW * 0.26, vaseY);
    ctx.bezierCurveTo(vaseX - vaseW * 0.4, vaseY - vaseH * 0.25, vaseX - vaseW * 0.42, vaseY - vaseH * 0.6, vaseX - vaseW * 0.16, vaseY - vaseH * 0.85);
    ctx.bezierCurveTo(vaseX - vaseW * 0.1, vaseY - vaseH * 0.95, vaseX - vaseW * 0.06, vaseY - vaseH, vaseX, vaseY - vaseH);
    ctx.bezierCurveTo(vaseX + vaseW * 0.06, vaseY - vaseH, vaseX + vaseW * 0.1, vaseY - vaseH * 0.95, vaseX + vaseW * 0.16, vaseY - vaseH * 0.85);
    ctx.bezierCurveTo(vaseX + vaseW * 0.42, vaseY - vaseH * 0.6, vaseX + vaseW * 0.4, vaseY - vaseH * 0.25, vaseX + vaseW * 0.26, vaseY);
    ctx.closePath();

    const grad = ctx.createLinearGradient(vaseX - vaseW/2, 0, vaseX + vaseW/2, 0);
    grad.addColorStop(0, 'rgba(70,90,100,0.75)');
    grad.addColorStop(0.25, 'rgba(110,140,150,0.55)');
    grad.addColorStop(0.5, 'rgba(150,180,190,0.45)');
    grad.addColorStop(0.75, 'rgba(110,140,150,0.55)');
    grad.addColorStop(1, 'rgba(70,90,100,0.75)');
    ctx.fillStyle = grad;
    ctx.fill();

    // Highlight
    ctx.beginPath();
    ctx.moveTo(vaseX - vaseW * 0.12, vaseY - vaseH * 0.88);
    ctx.bezierCurveTo(vaseX - vaseW * 0.22, vaseY - vaseH * 0.5, vaseX - vaseW * 0.25, vaseY - vaseH * 0.25, vaseX - vaseW * 0.16, vaseY - vaseH * 0.08);
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 2;
    ctx.stroke();

    // Rim
    ctx.beginPath();
    ctx.ellipse(vaseX, vaseY - vaseH, vaseW * 0.09, 4, 0, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(90,110,120,0.8)';
    ctx.fill();
}

function resize() {
    const container = document.querySelector('.canvas-container');
    const maxW = container.clientWidth - 70;
    const maxH = container.clientHeight - 70;
    const s = Math.min(maxW, maxH, 620);
    canvas.width = s;
    canvas.height = s;
    redraw();
}

function redraw() {
    // Warm background
    const bg = ctx.createLinearGradient(0, 0, 0, canvas.height);
    bg.addColorStop(0, '#e6d8c4');
    bg.addColorStop(0.5, '#dcceb8');
    bg.addColorStop(1, '#cec0aa');
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Texture
    ctx.globalAlpha = 0.025;
    for (let i = 0; i < 2500; i++) {
        ctx.fillStyle = Math.random() > 0.5 ? '#000' : '#fff';
        ctx.fillRect(Math.random() * canvas.width, Math.random() * canvas.height, 1, 1);
    }
    ctx.globalAlpha = 1;

    // Draw flowers
    placed.forEach(p => {
        const flower = flowerCutouts[p.flowerIndex];
        if (flower && flower.canvas) {
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rotation);
            if (p.flipped) ctx.scale(-1, 1);
            const scale = p.size / flower.canvas.width;
            const w = flower.canvas.width * scale;
            const h = flower.canvas.height * scale;
            ctx.drawImage(flower.canvas, -w/2, -h/2, w, h);
            ctx.restore();
        }
    });

    drawVase(ctx, canvas.width, canvas.height);
}

function placeFlower(x, y) {
    history.push(JSON.stringify(placed));
    placed.push({ flowerIndex: selectedFlower, x, y, size, rotation, flipped });
    redraw();
}

function undo() {
    if (history.length) {
        placed = JSON.parse(history.pop());
        redraw();
    }
}

function clearAll() {
    if (placed.length) {
        history.push(JSON.stringify(placed));
        placed = [];
        redraw();
    }
}

function toggleFlip() {
    flipped = !flipped;
    const btn = document.getElementById('flipBtn');
    btn.style.background = flipped ? 'rgba(180,140,80,0.2)' : 'transparent';
    btn.style.borderColor = flipped ? '#b48c50' : 'rgba(255,255,255,0.15)';
}

function save() {
    const link = document.createElement('a');
    link.download = 'masters-arrangement.png';
    link.href = canvas.toDataURL();
    link.click();
}

function init() {
    resize();

    const sectionsDiv = document.getElementById('artistSections');
    let flowerIdx = 0;

    // Group flowers by painting
    const grouped = {};
    flowerCutouts.forEach((f, i) => {
        const key = f.title;
        if (!grouped[key]) grouped[key] = { artist: f.artist, title: f.title, url: f.thumbUrl, flowers: [] };
        grouped[key].flowers.push({ ...f, index: i });
    });

    Object.values(grouped).forEach(painting => {
        const section = document.createElement('div');
        section.className = 'artist-section';

        const header = document.createElement('div');
        header.className = 'artist-header';

        const thumb = document.createElement('img');
        thumb.className = 'artist-thumb';
        thumb.src = painting.url;
        header.appendChild(thumb);

        const info = document.createElement('div');
        info.className = 'artist-info';
        info.innerHTML = `<h3>${painting.artist}</h3><p>${painting.title}</p>`;
        header.appendChild(info);

        section.appendChild(header);

        const row = document.createElement('div');
        row.className = 'flowers-row';

        painting.flowers.forEach(flower => {
            const btn = document.createElement('button');
            btn.className = 'flower-btn' + (flower.index === 0 ? ' active' : '');
            btn.title = flower.name;

            const preview = document.createElement('canvas');
            preview.width = 54;
            preview.height = 54;
            const pCtx = preview.getContext('2d');
            pCtx.drawImage(flower.canvas, 0, 0, 54, 54);
            btn.appendChild(preview);

            btn.onclick = () => {
                document.querySelectorAll('.flower-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedFlower = flower.index;
            };

            row.appendChild(btn);
        });

        section.appendChild(row);
        sectionsDiv.appendChild(section);
    });

    // Size slider
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeVal = document.getElementById('sizeVal');
    sizeSlider.oninput = e => {
        size = +e.target.value;
        sizeVal.textContent = size;
    };

    // Canvas events
    canvas.onclick = e => {
        const rect = canvas.getBoundingClientRect();
        placeFlower(e.clientX - rect.left, e.clientY - rect.top);
    };

    canvas.oncontextmenu = e => {
        e.preventDefault();
        const rect = canvas.getBoundingClientRect();
        const mx = e.clientX - rect.left, my = e.clientY - rect.top;
        for (let i = placed.length - 1; i >= 0; i--) {
            if (Math.hypot(placed[i].x - mx, placed[i].y - my) < placed[i].size / 2) {
                history.push(JSON.stringify(placed));
                placed.splice(i, 1);
                redraw();
                break;
            }
        }
    };

    canvas.onwheel = e => {
        e.preventDefault();
        rotation += e.deltaY * 0.01;
    };
}

window.onresize = resize;
loadPaintings();
</script>
</body>
</html>
