<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atelier 3D - Arrange the Masters</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;1,400&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Cormorant Garamond', Georgia, serif;
            background: #1a1612;
            min-height: 100vh;
            color: #e8e0d5;
            overflow: hidden;
        }

        .app {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #252018 0%, #1a1612 100%);
            border-right: 1px solid rgba(255,255,255,0.08);
            display: flex;
            flex-direction: column;
            padding: 20px 16px;
            overflow-y: auto;
        }

        .logo {
            font-size: 20px;
            font-weight: 400;
            letter-spacing: 4px;
            color: #f0e6d8;
            margin-bottom: 4px;
        }

        .tagline {
            font-size: 11px;
            font-style: italic;
            color: #8a7a68;
            margin-bottom: 20px;
        }

        .artist-section {
            margin-bottom: 16px;
        }

        .artist-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .artist-thumb {
            width: 32px;
            height: 32px;
            border-radius: 4px;
            object-fit: cover;
            border: 1px solid rgba(255,255,255,0.15);
        }

        .artist-info h3 {
            font-size: 12px;
            font-weight: 400;
            font-style: italic;
            color: #c0b0a0;
        }

        .artist-info p {
            font-size: 9px;
            color: #6a5a48;
        }

        .flowers-row {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .flower-btn {
            width: 50px;
            height: 50px;
            border: 2px solid transparent;
            border-radius: 6px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: all 0.25s ease;
            padding: 3px;
            overflow: hidden;
        }

        .flower-btn canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .flower-btn:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.2);
            transform: scale(1.05);
        }

        .flower-btn.active {
            background: rgba(180,140,80,0.15);
            border-color: #b48c50;
            box-shadow: 0 0 12px rgba(180,140,80,0.25);
        }

        .controls {
            margin-top: auto;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .control-row {
            margin-bottom: 12px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #6a5a48;
            margin-bottom: 6px;
        }

        .slider {
            width: 100%;
            height: 3px;
            -webkit-appearance: none;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 12px;
            height: 12px;
            background: #b48c50;
            border-radius: 50%;
            cursor: pointer;
        }

        .btn-row {
            display: flex;
            gap: 6px;
        }

        .btn {
            flex: 1;
            padding: 8px 10px;
            border: 1px solid rgba(255,255,255,0.15);
            background: transparent;
            color: #a09080;
            font-family: inherit;
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
        }

        .btn:hover {
            background: rgba(255,255,255,0.08);
            color: #e0d8c8;
        }

        .btn.primary {
            background: rgba(180,140,80,0.2);
            border-color: #b48c50;
            color: #b48c50;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: radial-gradient(ellipse at center, #2a2420 0%, #1a1612 100%);
        }

        #threeCanvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .help {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-style: italic;
            color: #5a4a38;
            text-align: center;
        }

        .loading {
            position: fixed;
            inset: 0;
            background: #1a1612;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 1000;
        }

        .loading.hidden { display: none; }

        .loading-text { font-size: 12px; letter-spacing: 3px; color: #8a7a68; }

        .loader {
            width: 24px; height: 24px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: #b48c50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading" id="loading">
        <div class="loader"></div>
        <div class="loading-text">PREPARING 3D ATELIER</div>
    </div>

    <div class="app">
        <div class="sidebar">
            <div class="logo">ATELIER 3D</div>
            <div class="tagline">Flowers cut from the masters</div>
            <div id="artistSections"></div>

            <div class="controls">
                <div class="control-row">
                    <div class="control-label">
                        <span>Size</span>
                        <span id="sizeVal">1.0</span>
                    </div>
                    <input type="range" class="slider" id="sizeSlider" min="0.3" max="2.0" step="0.1" value="1.0">
                </div>
                <div class="control-row">
                    <div class="control-label">
                        <span>Height</span>
                        <span id="heightVal">0</span>
                    </div>
                    <input type="range" class="slider" id="heightSlider" min="-2" max="5" step="0.2" value="2">
                </div>
                <div class="btn-row">
                    <button class="btn" onclick="undo()">Undo</button>
                    <button class="btn" onclick="clearAll()">Clear</button>
                </div>
                <div class="btn-row" style="margin-top: 6px">
                    <button class="btn primary" onclick="save()">Save Image</button>
                </div>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="threeCanvas"></canvas>
        </div>
    </div>

    <div class="help">Click to place flowers · Drag to rotate view · Scroll to zoom · Right-click to remove</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
// Paintings with hand-traced flower cutout paths
const PAINTINGS = [
    {
        artist: 'Vincent van Gogh',
        title: 'Sunflowers, 1888',
        url: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/Vincent_van_Gogh_-_Sunflowers_-_VGM_F458.jpg',
        flowers: [
            {
                name: 'Golden Crown',
                path: [
                    [0.50, 0.05], [0.45, 0.06], [0.42, 0.04], [0.38, 0.07],
                    [0.35, 0.05], [0.32, 0.09], [0.30, 0.08], [0.28, 0.12],
                    [0.26, 0.15], [0.28, 0.18], [0.26, 0.21], [0.29, 0.24],
                    [0.32, 0.26], [0.36, 0.25], [0.40, 0.27], [0.44, 0.26],
                    [0.48, 0.28], [0.52, 0.28], [0.56, 0.26], [0.60, 0.27],
                    [0.64, 0.25], [0.68, 0.26], [0.71, 0.24], [0.74, 0.21],
                    [0.72, 0.18], [0.74, 0.15], [0.72, 0.12], [0.70, 0.08],
                    [0.68, 0.09], [0.65, 0.05], [0.62, 0.07], [0.58, 0.04],
                    [0.55, 0.06], [0.50, 0.05]
                ]
            },
            {
                name: 'Leaning Left',
                path: [
                    [0.22, 0.14], [0.18, 0.12], [0.14, 0.14], [0.11, 0.18],
                    [0.10, 0.22], [0.12, 0.26], [0.10, 0.30], [0.14, 0.34],
                    [0.18, 0.36], [0.24, 0.35], [0.29, 0.32], [0.32, 0.28],
                    [0.33, 0.23], [0.31, 0.19], [0.28, 0.15], [0.22, 0.14]
                ]
            },
            {
                name: 'Right Bloom',
                path: [
                    [0.78, 0.12], [0.74, 0.10], [0.70, 0.12], [0.67, 0.16],
                    [0.66, 0.21], [0.68, 0.26], [0.72, 0.30], [0.77, 0.31],
                    [0.82, 0.29], [0.86, 0.25], [0.88, 0.20], [0.87, 0.15],
                    [0.84, 0.11], [0.78, 0.12]
                ]
            },
            {
                name: 'Center Face',
                path: [
                    [0.50, 0.30], [0.44, 0.32], [0.39, 0.36], [0.37, 0.42],
                    [0.39, 0.48], [0.44, 0.52], [0.50, 0.53], [0.56, 0.52],
                    [0.61, 0.48], [0.63, 0.42], [0.61, 0.36], [0.56, 0.32],
                    [0.50, 0.30]
                ]
            }
        ]
    },
    {
        artist: 'Claude Monet',
        title: 'Water Lilies, 1906',
        url: 'https://upload.wikimedia.org/wikipedia/commons/a/aa/Claude_Monet_-_Water_Lilies_-_1906%2C_Ryerson.jpg',
        flowers: [
            {
                name: 'Red Lily',
                path: [
                    [0.18, 0.22], [0.13, 0.24], [0.10, 0.28], [0.09, 0.33],
                    [0.11, 0.38], [0.16, 0.41], [0.22, 0.42], [0.27, 0.39],
                    [0.30, 0.34], [0.29, 0.28], [0.25, 0.24], [0.18, 0.22]
                ]
            },
            {
                name: 'Right Cluster',
                path: [
                    [0.72, 0.35], [0.65, 0.38], [0.60, 0.44], [0.58, 0.52],
                    [0.62, 0.60], [0.70, 0.64], [0.80, 0.62], [0.88, 0.56],
                    [0.92, 0.48], [0.90, 0.40], [0.84, 0.36], [0.72, 0.35]
                ]
            },
            {
                name: 'Bottom Lilies',
                path: [
                    [0.25, 0.72], [0.18, 0.76], [0.14, 0.82], [0.16, 0.88],
                    [0.24, 0.92], [0.36, 0.94], [0.48, 0.92], [0.56, 0.86],
                    [0.54, 0.78], [0.46, 0.74], [0.36, 0.72], [0.25, 0.72]
                ]
            },
            {
                name: 'Pink Bloom',
                path: [
                    [0.42, 0.48], [0.36, 0.50], [0.32, 0.55], [0.34, 0.61],
                    [0.40, 0.65], [0.48, 0.66], [0.54, 0.62], [0.56, 0.56],
                    [0.52, 0.50], [0.46, 0.48], [0.42, 0.48]
                ]
            }
        ]
    },
    {
        artist: 'Gustav Klimt',
        title: 'Cottage Garden, 1907',
        url: 'https://upload.wikimedia.org/wikipedia/commons/e/ed/Klimt_bauerngarten.jpg',
        flowers: [
            {
                name: 'Giant Sunflower',
                path: [
                    [0.50, 0.02], [0.42, 0.04], [0.36, 0.03], [0.30, 0.06],
                    [0.26, 0.10], [0.24, 0.16], [0.26, 0.22], [0.30, 0.26],
                    [0.36, 0.28], [0.42, 0.29], [0.50, 0.30], [0.58, 0.29],
                    [0.64, 0.28], [0.70, 0.26], [0.74, 0.22], [0.76, 0.16],
                    [0.74, 0.10], [0.70, 0.06], [0.64, 0.03], [0.58, 0.04],
                    [0.50, 0.02]
                ]
            },
            {
                name: 'Red Poppies',
                path: [
                    [0.20, 0.50], [0.12, 0.54], [0.08, 0.62], [0.10, 0.70],
                    [0.18, 0.76], [0.28, 0.78], [0.38, 0.74], [0.44, 0.66],
                    [0.42, 0.58], [0.34, 0.52], [0.20, 0.50]
                ]
            },
            {
                name: 'White Daisies',
                path: [
                    [0.48, 0.42], [0.40, 0.46], [0.36, 0.54], [0.38, 0.62],
                    [0.46, 0.68], [0.56, 0.70], [0.66, 0.66], [0.70, 0.58],
                    [0.68, 0.50], [0.60, 0.44], [0.48, 0.42]
                ]
            },
            {
                name: 'Purple Patch',
                path: [
                    [0.72, 0.48], [0.64, 0.52], [0.60, 0.60], [0.62, 0.70],
                    [0.70, 0.78], [0.82, 0.80], [0.92, 0.74], [0.96, 0.64],
                    [0.92, 0.54], [0.82, 0.50], [0.72, 0.48]
                ]
            }
        ]
    },
    {
        artist: 'Vincent van Gogh',
        title: 'Irises, 1889',
        url: 'https://upload.wikimedia.org/wikipedia/commons/3/3e/Irises-Vincent_van_Gogh.jpg',
        flowers: [
            {
                name: 'Blue Iris Left',
                path: [
                    [0.15, 0.18], [0.10, 0.22], [0.08, 0.28], [0.10, 0.36],
                    [0.14, 0.44], [0.12, 0.52], [0.16, 0.58], [0.22, 0.56],
                    [0.26, 0.48], [0.24, 0.40], [0.28, 0.32], [0.26, 0.24],
                    [0.22, 0.18], [0.15, 0.18]
                ]
            },
            {
                name: 'Center Iris',
                path: [
                    [0.42, 0.24], [0.35, 0.28], [0.32, 0.36], [0.35, 0.44],
                    [0.40, 0.50], [0.48, 0.52], [0.55, 0.48], [0.58, 0.40],
                    [0.56, 0.32], [0.50, 0.26], [0.42, 0.24]
                ]
            },
            {
                name: 'Right Iris',
                path: [
                    [0.68, 0.20], [0.62, 0.24], [0.58, 0.32], [0.60, 0.42],
                    [0.66, 0.50], [0.74, 0.52], [0.82, 0.48], [0.86, 0.38],
                    [0.84, 0.28], [0.78, 0.22], [0.68, 0.20]
                ]
            },
            {
                name: 'White Iris',
                path: [
                    [0.24, 0.62], [0.18, 0.66], [0.16, 0.74], [0.20, 0.82],
                    [0.28, 0.86], [0.38, 0.84], [0.44, 0.78], [0.42, 0.70],
                    [0.36, 0.64], [0.24, 0.62]
                ]
            }
        ]
    }
];

// Three.js setup
let scene, camera, renderer, raycaster, mouse;
let vase, table;
let flowerCutouts = [];
let placedFlowers = [];
let selectedFlower = 0;
let flowerSize = 1.0;
let flowerHeight = 2;
let history = [];
let isDragging = false;
let previousMousePosition = { x: 0, y: 0 };
let cameraAngle = 0;
let cameraHeight = 3;
let cameraDistance = 12;

function cutOutFlower(img, path, padding = 0.03) {
    let minX = 1, maxX = 0, minY = 1, maxY = 0;
    path.forEach(([x, y]) => {
        minX = Math.min(minX, x);
        maxX = Math.max(maxX, x);
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
    });

    minX = Math.max(0, minX - padding);
    maxX = Math.min(1, maxX + padding);
    minY = Math.max(0, minY - padding);
    maxY = Math.min(1, maxY + padding);

    const srcX = minX * img.width;
    const srcY = minY * img.height;
    const srcW = (maxX - minX) * img.width;
    const srcH = (maxY - minY) * img.height;

    const cutoutSize = 512;
    const scale = cutoutSize / Math.max(srcW, srcH);
    const w = srcW * scale;
    const h = srcH * scale;

    const offCanvas = document.createElement('canvas');
    offCanvas.width = cutoutSize;
    offCanvas.height = cutoutSize;
    const offCtx = offCanvas.getContext('2d');

    const offsetX = (cutoutSize - w) / 2;
    const offsetY = (cutoutSize - h) / 2;

    const points = path.map(([px, py]) => ({
        x: ((px - minX) / (maxX - minX)) * w + offsetX,
        y: ((py - minY) / (maxY - minY)) * h + offsetY
    }));

    // Draw smooth curved path
    offCtx.beginPath();
    if (points.length > 2) {
        offCtx.moveTo(points[0].x, points[0].y);
        for (let i = 0; i < points.length; i++) {
            const p0 = points[(i - 1 + points.length) % points.length];
            const p1 = points[i];
            const p2 = points[(i + 1) % points.length];
            const p3 = points[(i + 2) % points.length];
            const tension = 0.5;
            const cp1x = p1.x + (p2.x - p0.x) * tension / 3;
            const cp1y = p1.y + (p2.y - p0.y) * tension / 3;
            const cp2x = p2.x - (p3.x - p1.x) * tension / 3;
            const cp2y = p2.y - (p3.y - p1.y) * tension / 3;
            offCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
        }
    }
    offCtx.closePath();

    offCtx.save();
    offCtx.clip();
    offCtx.drawImage(img, srcX, srcY, srcW, srcH, offsetX, offsetY, w, h);
    offCtx.restore();

    // Soft edge
    offCtx.save();
    offCtx.globalCompositeOperation = 'destination-out';
    for (let blur = 8; blur > 0; blur--) {
        offCtx.lineWidth = blur;
        offCtx.strokeStyle = `rgba(0,0,0,${0.12 * (blur / 8)})`;
        offCtx.beginPath();
        if (points.length > 2) {
            offCtx.moveTo(points[0].x, points[0].y);
            for (let i = 0; i < points.length; i++) {
                const p0 = points[(i - 1 + points.length) % points.length];
                const p1 = points[i];
                const p2 = points[(i + 1) % points.length];
                const p3 = points[(i + 2) % points.length];
                const tension = 0.5;
                const cp1x = p1.x + (p2.x - p0.x) * tension / 3;
                const cp1y = p1.y + (p2.y - p0.y) * tension / 3;
                const cp2x = p2.x - (p3.x - p1.x) * tension / 3;
                const cp2y = p2.y - (p3.y - p1.y) * tension / 3;
                offCtx.bezierCurveTo(cp1x, cp1y, cp2x, cp2y, p2.x, p2.y);
            }
        }
        offCtx.closePath();
        offCtx.stroke();
    }
    offCtx.restore();

    return offCanvas;
}

async function loadPaintings() {
    for (const painting of PAINTINGS) {
        await new Promise(resolve => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                painting.flowers.forEach(flower => {
                    const canvas = cutOutFlower(img, flower.path);
                    flowerCutouts.push({
                        canvas,
                        name: flower.name,
                        artist: painting.artist,
                        title: painting.title,
                        thumbUrl: painting.url
                    });
                });
                resolve();
            };
            img.onerror = () => resolve();
            img.src = painting.url;
        });
    }
}

function createVase() {
    // Vase profile points
    const points = [];
    const profile = [
        [0, 0], [0.8, 0.1], [1.2, 0.5], [1.4, 1.2], [1.3, 2.0],
        [1.1, 2.8], [0.9, 3.4], [0.7, 3.8], [0.6, 4.0], [0.55, 4.1],
        [0.5, 4.15], [0.52, 4.2], [0.6, 4.25]
    ];

    profile.forEach(([x, y]) => {
        points.push(new THREE.Vector2(x, y - 2));
    });

    const geometry = new THREE.LatheGeometry(points, 32);

    // Glass material
    const material = new THREE.MeshPhysicalMaterial({
        color: 0x88aaaa,
        metalness: 0.0,
        roughness: 0.1,
        transmission: 0.9,
        thickness: 0.5,
        transparent: true,
        opacity: 0.6,
        side: THREE.DoubleSide
    });

    vase = new THREE.Mesh(geometry, material);
    vase.position.y = -1.5;
    vase.castShadow = true;
    vase.receiveShadow = true;
    scene.add(vase);
}

function createTable() {
    // Simple table surface
    const geometry = new THREE.CylinderGeometry(6, 6, 0.3, 32);
    const material = new THREE.MeshStandardMaterial({
        color: 0x3a2820,
        roughness: 0.8,
        metalness: 0.1
    });
    table = new THREE.Mesh(geometry, material);
    table.position.y = -3.65;
    table.receiveShadow = true;
    scene.add(table);
}

function createFlowerSprite(flowerIndex, position, size) {
    const cutout = flowerCutouts[flowerIndex];
    if (!cutout) return null;

    const texture = new THREE.CanvasTexture(cutout.canvas);
    texture.needsUpdate = true;

    const material = new THREE.SpriteMaterial({
        map: texture,
        transparent: true,
        alphaTest: 0.1
    });

    const sprite = new THREE.Sprite(material);
    sprite.position.copy(position);
    sprite.scale.set(size * 2, size * 2, 1);
    sprite.userData = { flowerIndex, size };

    return sprite;
}

function addStem(flowerSprite) {
    // Create a curved stem from vase opening to flower
    const startY = 0.8; // Top of vase
    const endY = flowerSprite.position.y;
    const endX = flowerSprite.position.x;
    const endZ = flowerSprite.position.z;

    const curve = new THREE.CatmullRomCurve3([
        new THREE.Vector3(0, startY, 0),
        new THREE.Vector3(endX * 0.3, startY + (endY - startY) * 0.3, endZ * 0.3),
        new THREE.Vector3(endX * 0.7, startY + (endY - startY) * 0.7, endZ * 0.7),
        new THREE.Vector3(endX, endY - flowerSprite.scale.y * 0.4, endZ)
    ]);

    const geometry = new THREE.TubeGeometry(curve, 20, 0.05, 8, false);
    const material = new THREE.MeshStandardMaterial({
        color: 0x3d5c3d,
        roughness: 0.8
    });

    const stem = new THREE.Mesh(geometry, material);
    stem.castShadow = true;
    return stem;
}

function placeFlower(x, z) {
    if (selectedFlower >= flowerCutouts.length) return;

    const position = new THREE.Vector3(x, flowerHeight, z);
    const sprite = createFlowerSprite(selectedFlower, position, flowerSize);
    if (!sprite) return;

    const stem = addStem(sprite);

    const group = new THREE.Group();
    group.add(sprite);
    group.add(stem);
    group.userData = { flowerIndex: selectedFlower, sprite, stem };

    scene.add(group);

    history.push([...placedFlowers.map(f => f.uuid)]);
    placedFlowers.push(group);
}

function undo() {
    if (placedFlowers.length > 0) {
        const removed = placedFlowers.pop();
        scene.remove(removed);
    }
}

function clearAll() {
    while (placedFlowers.length > 0) {
        const removed = placedFlowers.pop();
        scene.remove(removed);
    }
    history = [];
}

function save() {
    renderer.render(scene, camera);
    const link = document.createElement('a');
    link.download = 'arrangement-3d.png';
    link.href = renderer.domElement.toDataURL();
    link.click();
}

function initThree() {
    const container = document.getElementById('canvasContainer');
    const canvas = document.getElementById('threeCanvas');

    // Scene
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a1612);

    // Camera
    camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 100);
    updateCameraPosition();

    // Renderer
    renderer = new THREE.WebGLRenderer({ canvas, antialias: true, preserveDrawingBuffer: true });
    renderer.setSize(container.clientWidth, container.clientHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    // Lights
    const ambient = new THREE.AmbientLight(0xfff5e6, 0.6);
    scene.add(ambient);

    const mainLight = new THREE.DirectionalLight(0xfff8f0, 1.0);
    mainLight.position.set(5, 10, 5);
    mainLight.castShadow = true;
    mainLight.shadow.mapSize.width = 2048;
    mainLight.shadow.mapSize.height = 2048;
    mainLight.shadow.camera.near = 0.5;
    mainLight.shadow.camera.far = 50;
    mainLight.shadow.camera.left = -10;
    mainLight.shadow.camera.right = 10;
    mainLight.shadow.camera.top = 10;
    mainLight.shadow.camera.bottom = -10;
    scene.add(mainLight);

    const fillLight = new THREE.DirectionalLight(0xe8dcc8, 0.4);
    fillLight.position.set(-5, 5, -5);
    scene.add(fillLight);

    // Raycaster for click detection
    raycaster = new THREE.Raycaster();
    mouse = new THREE.Vector2();

    // Create scene objects
    createVase();
    createTable();

    // Background gradient sphere
    const bgGeom = new THREE.SphereGeometry(40, 32, 32);
    const bgMat = new THREE.ShaderMaterial({
        uniforms: {
            topColor: { value: new THREE.Color(0x2a2420) },
            bottomColor: { value: new THREE.Color(0x1a1612) }
        },
        vertexShader: `
            varying vec3 vWorldPosition;
            void main() {
                vec4 worldPosition = modelMatrix * vec4(position, 1.0);
                vWorldPosition = worldPosition.xyz;
                gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
            }
        `,
        fragmentShader: `
            uniform vec3 topColor;
            uniform vec3 bottomColor;
            varying vec3 vWorldPosition;
            void main() {
                float h = normalize(vWorldPosition).y * 0.5 + 0.5;
                gl_FragColor = vec4(mix(bottomColor, topColor, h), 1.0);
            }
        `,
        side: THREE.BackSide
    });
    const bgSphere = new THREE.Mesh(bgGeom, bgMat);
    scene.add(bgSphere);

    // Event listeners
    canvas.addEventListener('mousedown', onMouseDown);
    canvas.addEventListener('mousemove', onMouseMove);
    canvas.addEventListener('mouseup', onMouseUp);
    canvas.addEventListener('wheel', onWheel);
    canvas.addEventListener('contextmenu', onRightClick);
    window.addEventListener('resize', onResize);

    animate();
}

function updateCameraPosition() {
    camera.position.x = Math.sin(cameraAngle) * cameraDistance;
    camera.position.z = Math.cos(cameraAngle) * cameraDistance;
    camera.position.y = cameraHeight;
    camera.lookAt(0, 1, 0);
}

function onMouseDown(e) {
    if (e.button === 0) {
        isDragging = true;
        previousMousePosition = { x: e.clientX, y: e.clientY };
    }
}

function onMouseMove(e) {
    if (isDragging) {
        const deltaX = e.clientX - previousMousePosition.x;
        const deltaY = e.clientY - previousMousePosition.y;

        cameraAngle += deltaX * 0.01;
        cameraHeight = Math.max(-2, Math.min(10, cameraHeight - deltaY * 0.05));

        updateCameraPosition();
        previousMousePosition = { x: e.clientX, y: e.clientY };
    }
}

function onMouseUp(e) {
    if (e.button === 0 && isDragging) {
        const moved = Math.abs(e.clientX - previousMousePosition.x) > 5 ||
                      Math.abs(e.clientY - previousMousePosition.y) > 5;

        if (!moved) {
            // Click to place flower
            const container = document.getElementById('canvasContainer');
            const rect = container.getBoundingClientRect();
            mouse.x = ((e.clientX - rect.left) / container.clientWidth) * 2 - 1;
            mouse.y = -((e.clientY - rect.top) / container.clientHeight) * 2 + 1;

            raycaster.setFromCamera(mouse, camera);

            // Create a placement plane at the flower height
            const planeY = flowerHeight;
            const plane = new THREE.Plane(new THREE.Vector3(0, 1, 0), -planeY);
            const intersectPoint = new THREE.Vector3();

            if (raycaster.ray.intersectPlane(plane, intersectPoint)) {
                // Limit placement radius
                const dist = Math.sqrt(intersectPoint.x ** 2 + intersectPoint.z ** 2);
                if (dist < 4) {
                    placeFlower(intersectPoint.x, intersectPoint.z);
                }
            }
        }
        isDragging = false;
    }
}

function onWheel(e) {
    e.preventDefault();
    cameraDistance = Math.max(5, Math.min(25, cameraDistance + e.deltaY * 0.02));
    updateCameraPosition();
}

function onRightClick(e) {
    e.preventDefault();

    const container = document.getElementById('canvasContainer');
    const rect = container.getBoundingClientRect();
    mouse.x = ((e.clientX - rect.left) / container.clientWidth) * 2 - 1;
    mouse.y = -((e.clientY - rect.top) / container.clientHeight) * 2 + 1;

    raycaster.setFromCamera(mouse, camera);

    // Check intersection with flower sprites
    const sprites = placedFlowers.map(g => g.userData.sprite).filter(Boolean);
    const intersects = raycaster.intersectObjects(sprites);

    if (intersects.length > 0) {
        const hitSprite = intersects[0].object;
        const groupToRemove = placedFlowers.find(g => g.userData.sprite === hitSprite);
        if (groupToRemove) {
            scene.remove(groupToRemove);
            placedFlowers = placedFlowers.filter(g => g !== groupToRemove);
        }
    }
}

function onResize() {
    const container = document.getElementById('canvasContainer');
    camera.aspect = container.clientWidth / container.clientHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(container.clientWidth, container.clientHeight);
}

function animate() {
    requestAnimationFrame(animate);
    renderer.render(scene, camera);
}

function buildUI() {
    const sectionsDiv = document.getElementById('artistSections');

    const grouped = {};
    flowerCutouts.forEach((f, i) => {
        const key = f.title;
        if (!grouped[key]) grouped[key] = { artist: f.artist, title: f.title, url: f.thumbUrl, flowers: [] };
        grouped[key].flowers.push({ ...f, index: i });
    });

    Object.values(grouped).forEach(painting => {
        const section = document.createElement('div');
        section.className = 'artist-section';

        const header = document.createElement('div');
        header.className = 'artist-header';

        const thumb = document.createElement('img');
        thumb.className = 'artist-thumb';
        thumb.src = painting.url;
        header.appendChild(thumb);

        const info = document.createElement('div');
        info.className = 'artist-info';
        info.innerHTML = `<h3>${painting.artist}</h3><p>${painting.title}</p>`;
        header.appendChild(info);

        section.appendChild(header);

        const row = document.createElement('div');
        row.className = 'flowers-row';

        painting.flowers.forEach(flower => {
            const btn = document.createElement('button');
            btn.className = 'flower-btn' + (flower.index === 0 ? ' active' : '');
            btn.title = flower.name;

            const preview = document.createElement('canvas');
            preview.width = 46;
            preview.height = 46;
            const pCtx = preview.getContext('2d');
            pCtx.drawImage(flower.canvas, 0, 0, 46, 46);
            btn.appendChild(preview);

            btn.onclick = () => {
                document.querySelectorAll('.flower-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                selectedFlower = flower.index;
            };

            row.appendChild(btn);
        });

        section.appendChild(row);
        sectionsDiv.appendChild(section);
    });

    // Size slider
    const sizeSlider = document.getElementById('sizeSlider');
    const sizeVal = document.getElementById('sizeVal');
    sizeSlider.oninput = e => {
        flowerSize = +e.target.value;
        sizeVal.textContent = flowerSize.toFixed(1);
    };

    // Height slider
    const heightSlider = document.getElementById('heightSlider');
    const heightVal = document.getElementById('heightVal');
    heightSlider.oninput = e => {
        flowerHeight = +e.target.value;
        heightVal.textContent = flowerHeight.toFixed(1);
    };
}

async function init() {
    await loadPaintings();
    initThree();
    buildUI();
    document.getElementById('loading').classList.add('hidden');
}

init();
    </script>
</body>
</html>
